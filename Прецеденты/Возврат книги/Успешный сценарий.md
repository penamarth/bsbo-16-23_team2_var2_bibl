Возврат книги

Возврат книги начинается, когда пользователь приносит физический экземпляр книги в библиотеку. Библиотекарь сканирует QR-код или штрих-код с книги, чтобы получить идентификатор книжного экземпляра (bookItemId).

Первым делом система вызывает метод CheckReturnBook(bookItemId) из класса ISB. Этот метод ищет активный займ (Loan), связанный с данным экземпляром книги. Он проходит по всем активным займам в словаре activeLoans и ищет тот, у которого свойство BookItemId совпадает с переданным идентификатором.

Когда займ найден, система вычисляет разницу между текущей датой и датой возврата (DueDate). Если текущая дата позже даты возврата, значит книга сдана с опозданием. Метод возвращает true, если есть просрочка (дней просрочки больше нуля), или false, если книга возвращена вовремя.

Если книга сдана с опозданием, система должна обработать этот случай. На практике здесь должна быть логика начисления штрафа: расчет суммы штрафа на основе количества дней просрочки, возможно уведомление пользователя о штрафе через NotificationService, и изменение статуса аккаунта пользователя на "HasFines" или аналогичный. Однако в текущей реализации эта логика минимальна — метод просто возвращает булево значение.

После проверки наличия долга вызывается метод UpdateReturnBook(bookItemId). Этот метод снова ищет соответствующий займ в activeLoans. Когда займ найден, система получает идентификатор аккаунта (AccountId) из займа и находит соответствующий объект Account в словаре accounts.

С аккаунтом пользователя происходят важные изменения: свойство CurrentLoans уменьшается на единицу (это счетчик активных займов), и идентификатор книги удаляется из списка BooksOnHand, который хранит книги, находящиеся у пользователя на руках.

Затем система удаляет займ из словаря activeLoans по его идентификатору, что означает завершение цикла займа. Книга больше не числится выданной.

Однако на этом процесс не заканчивается. После того как книга возвращена и освободилась, система должна проверить, есть ли на эту книгу очередь резерваций. Для этого нужно найти ReservationQueue для данной книги по её идентификатору (bookId, а не bookItemId). В текущей реализации этого явно не происходит в методах возврата, но логически это необходимая часть.

Если очередь резерваций существует и в ней есть активные резервации, система вызывает метод GetNextReservation() у соответствующей ReservationQueue. Этот метод просматривает список резерваций и находит первую с статусом "Active".

Когда найдена следующая активная резервация, система вызывает метод NotifyNextReader() у очереди. Этот метод должен отправить уведомление пользователю, чья резервация теперь может быть выполнена. В идеале это включает получение контактной информации пользователя (email или телефон из Account) и отправку сообщения через NotificationService о том, что книга доступна для получения.

Одновременно с этим статус книжного экземпляра (BookInstance) должен быть обновлен. В текущей реализации этот аспект не полностью проработан, но логически BookInstance должен получить статус "Reserved" (если есть следующая резервация) или "Available" (если очереди нет). Местоположение книги (Location) в структуре хранения (Cell) остается прежним, но флаг доступности может измениться в зависимости от резервации.
```
@startuml

actor Читатель
actor Библиотекарь
participant "ИСБ" as ISB
participant "Учетная запись" as Account
participant "Каталог" as Catalog



Читатель -> Библиотекарь : показывает qr-code

activate ISB

Библиотекарь -> ISB : returnBook(id_book)

alt Если просрочил книгу

ISB -> Account : createLoan(user_id, bookItemId, issueDate, dueDate)
activate Account
deactivate Account

end

ISB -> ISB: updateReturnBook(id_book)
ISB -> Библиотекарь:

Библиотекарь -> ISB: searchBooks(title, author)


/'System -> Account : changeUserStatus(userId, bookId)'/
/'activate Account'/
/'System -> Catalog : changeBookStatus(bookId)'/
/'deactivate Account'/
/'activate Catalog'/
/'System -> Catalog : getShelfNum(bookId)'/
/'System <- Catalog : номер полки'/
/'deactivate Catalog'/
/'Библиотекарь <- System : номер полки'/
/'deactivate ISB'/

@enduml

```
